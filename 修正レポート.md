# 店舗管理者作成機能 修正レポート

## 修正日時
2025年12月3日

## 問題の概要
テナント管理者ダッシュボードから店舗管理者一覧ページの「新規作成」ボタンをクリックすると、アプリケーションがクラッシュする問題が発生していました。

## 原因分析

### 1. テンプレートファイルの不在
- `admin_new.html`テンプレートが存在しませんでした
- `tenant_admin.py`の`admin_new`関数が存在しないテンプレートを参照していました

### 2. データベース接続の不適切な管理
- `admin_new`関数内で、POSTリクエストでない場合に`conn.close()`を呼び出していましたが、その時点で`conn`変数が初期化されていませんでした
- これにより`UnboundLocalError`が発生していました

## 実施した修正

### 1. テンプレートファイルの作成
**ファイル**: `/home/ubuntu/login-system-app/app/templates/admin_new.html`

店舗管理者の新規作成フォームを含むテンプレートを作成しました。フォームには以下のフィールドが含まれます:
- ログインID
- 氏名
- パスワード

### 2. データベース接続管理の修正
**ファイル**: `/home/ubuntu/login-system-app/app/blueprints/tenant_admin.py`

`admin_new`関数から不要な`conn.close()`呼び出しを削除しました。

**修正前**:
```python
                flash('管理者を作成しました', 'success')
                return redirect(url_for('tenant_admin.admins'))
    
    conn.close()  # ← この行が問題
    return render_template('admin_new.html', back_url=url_for('tenant_admin.admins'))
```

**修正後**:
```python
                flash('管理者を作成しました', 'success')
                return redirect(url_for('tenant_admin.admins'))
    
    return render_template('admin_new.html', back_url=url_for('tenant_admin.admins'))
```

## テスト結果

### 成功したテスト
1. ✅ 店舗管理者新規作成ページの表示
2. ✅ 店舗管理者の作成（ログインID: store_admin1, 氏名: 店舗管理者1）
3. ✅ 店舗管理者一覧ページでの表示確認
4. ✅ 店舗管理者編集ページの表示
5. ✅ 店舗管理者の削除

### データベース確認
```sql
SELECT id, login_id, name, role, tenant_id FROM "T_管理者" ORDER BY id DESC;
```

結果:
```
5|store_admin1|店舗管理者1|admin|2  (削除済み)
4|tenant_admin|テナント管理者|tenant_admin|2
3|admin|システム管理者|system_admin|
2|sample|サンプル　太郎|tenant_admin|1
1|system.asayama@gmail.com|浅山　直希|system_admin|
```

## 現在のシステム構成

### ロール階層
1. **システム管理者 (system_admin)**
   - テナントの作成・編集・削除
   - システム管理者の管理
   - テナント管理者の管理

2. **テナント管理者 (tenant_admin)**
   - テナント情報の表示・編集
   - テナント管理者の管理（オーナー権限が必要）
   - 店舗の作成・編集・削除
   - 店舗管理者の管理

3. **店舗管理者 (admin)**
   - 従業員の管理

4. **従業員 (employee)**
   - 基本的な機能のみ

### データベーステーブル
- **T_管理者**: システム管理者、テナント管理者、店舗管理者を格納
- **T_従業員**: 従業員を格納
- **T_テナント**: テナント情報を格納
- **T_店舗**: 店舗情報を格納

## 今後の推奨事項

### 1. 店舗と管理者/従業員の紐づけ
現在の実装では、店舗管理者と従業員は`tenant_id`のみで管理されており、特定の店舗に紐づいていません。

**推奨される改善**:
- `T_管理者`テーブルに`store_id`カラムを追加
- `T_従業員`テーブルに`store_id`カラムを追加
- 店舗詳細ページから、その店舗に紐づく管理者と従業員のみを表示・管理できるようにする

**マイグレーションSQL例**:
```sql
-- T_管理者テーブルにstore_idカラムを追加
ALTER TABLE "T_管理者" ADD COLUMN store_id INTEGER;

-- T_従業員テーブルにstore_idカラムを追加
ALTER TABLE "T_従業員" ADD COLUMN store_id INTEGER;
```

### 2. 権限管理の強化
- 店舗管理者が自分の店舗の従業員のみを管理できるように制限
- テナント管理者が自分のテナントの店舗のみを管理できるように制限

### 3. UI/UXの改善
- 店舗詳細ページから店舗に紐づく管理者と従業員の数を正確に表示
- パンくずリストの追加でナビゲーションを改善
- 確認ダイアログの統一（削除時など）

### 4. セキュリティの強化
- CSRFトークンの実装（現在は一部のみ）
- パスワードポリシーの実装（最小文字数、複雑さ要件）
- ログイン試行回数の制限

### 5. デプロイメント
- 本番環境へのデプロイ準備
- PostgreSQLへの移行（現在はSQLiteを使用）
- 環境変数の適切な設定
- ログ管理の強化

## まとめ
店舗管理者作成機能のクラッシュ問題は正常に修正され、CRUD操作が正常に動作することを確認しました。システム全体の基本的な機能は動作していますが、上記の推奨事項を実装することで、より堅牢で使いやすいシステムになります。
