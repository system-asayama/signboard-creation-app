# 従業員有効/無効切り替え機能実装完了レポート

## 実装日時
2025年12月28日

## 実装概要

従業員一覧ページで、従業員の有効/無効を簡単に切り替えられる機能を実装しました。システム管理者とテナント管理者は、従業員一覧ページのカード内にあるボタンをクリックするだけで、従業員のアクティブ状態を切り替えることができます。

## 実装した機能

### 1. データベーススキーマの拡張

**T_従業員テーブルに`active`カラムを追加**しました。このカラムは従業員の有効/無効状態を管理します。

- **カラム名**: `active`
- **データ型**: `INTEGER`
- **デフォルト値**: `1`（有効）
- **値の意味**:
  - `1`: 有効（ログイン可能）
  - `0`: 無効（ログイン不可）

### 2. マイグレーションスクリプト

既存のデータベースに`active`カラムを追加するためのマイグレーションスクリプトを作成しました。

**ファイル**: `migrate_add_employee_active.py`

このスクリプトは以下の処理を行います：
- `active`カラムが既に存在するかチェック
- 存在しない場合は`active`カラムを追加
- 既存のすべての従業員を有効（`active = 1`）に設定

### 3. 従業員一覧ページの機能拡張

**従業員一覧ページ**（`/tenant_admin/employees`）に以下の機能を追加しました：

#### 有効/無効のトグルボタン

各従業員カードの「有効」列に、クリック可能なボタンを配置しました：

- **有効な従業員**: 緑色のボタンに「✓ 有効」と表示
- **無効な従業員**: グレーのボタンに「無効」と表示

ボタンをクリックすると、即座に状態が切り替わり、フラッシュメッセージで結果が通知されます。

#### 実装の詳細

```html
<form method="post" action="{{ url_for('tenant_admin.employee_toggle_active', employee_id=e.id) }}" style="display:inline">
  {% if e.active == 1 %}
    <button type="submit" class="btn small" style="background:#4caf50; color:white; border:none; cursor:pointer">✓ 有効</button>
  {% else %}
    <button type="submit" class="btn small" style="background:#999; color:white; border:none; cursor:pointer">無効</button>
  {% endif %}
</form>
```

### 4. 従業員編集ページの機能拡張

**従業員編集ページ**（`/tenant_admin/employees/<id>/edit`）にも有効/無効を切り替えるチェックボックスを追加しました。

#### チェックボックスの追加

編集フォームに以下のチェックボックスを追加：

```html
<div class="row">
  <label style="display:flex; align-items:center; gap:8px">
    <input type="checkbox" name="active" {% if employee.active == 1 %}checked{% endif %}>
    <span>有効（チェックを外すと無効になります）</span>
  </label>
</div>
```

チェックボックスをオンにすると有効、オフにすると無効になります。

### 5. バックエンドエンドポイントの追加

#### 有効/無効切り替えエンドポイント

**エンドポイント**: `/tenant_admin/employees/<int:employee_id>/toggle_active`

**メソッド**: `POST`

**処理内容**:
1. 従業員の現在の`active`状態を取得
2. 状態を反転（`1` → `0` または `0` → `1`）
3. データベースを更新
4. フラッシュメッセージで結果を通知
5. 従業員一覧ページにリダイレクト

**実装コード**:

```python
@bp.route('/employees/<int:employee_id>/toggle_active', methods=['POST'])
@require_roles(ROLES["TENANT_ADMIN"], ROLES["SYSTEM_ADMIN"])
def employee_toggle_active(employee_id):
    """従業員の有効/無効を切り替え"""
    tenant_id = session.get('tenant_id')
    conn = get_db_connection()
    cur = conn.cursor()
    
    # 従業員が存在するか確認
    cur.execute(_sql(conn, 'SELECT name, active FROM "T_従業員" WHERE id = %s AND tenant_id = %s'), (employee_id, tenant_id))
    row = cur.fetchone()
    
    if not row:
        flash('従業員が見つかりません', 'error')
    else:
        name = row[0]
        current_active = row[1]
        new_active = 0 if current_active == 1 else 1
        
        cur.execute(_sql(conn, 'UPDATE "T_従業員" SET active = %s WHERE id = %s AND tenant_id = %s'), 
                   (new_active, employee_id, tenant_id))
        conn.commit()
        
        status_text = '有効' if new_active == 1 else '無効'
        flash(f'従業員 "{name}" を{status_text}にしました', 'success')
    
    conn.close()
    return redirect(url_for('tenant_admin.employees'))
```

#### 従業員編集エンドポイントの更新

従業員編集エンドポイント（`/tenant_admin/employees/<int:employee_id>/edit`）を更新し、`active`フィールドの取得と更新に対応しました。

## 修正したファイル

### 1. データベーススキーマ
- **ファイル**: `app/utils/db.py`
- **変更内容**: `T_従業員`テーブルのCREATE文に`active INTEGER DEFAULT 1`を追加

### 2. バックエンド
- **ファイル**: `app/blueprints/tenant_admin.py`
- **変更内容**:
  - `employees()`関数：`active`カラムを取得するようにSQLを修正
  - `employee_toggle_active()`関数：新規追加
  - `employee_edit()`関数：`active`フィールドの取得と更新に対応

### 3. テンプレート
- **ファイル**: `app/templates/tenant_employees.html`
- **変更内容**: 有効/無効のトグルボタンを追加

- **ファイル**: `app/templates/tenant_employee_edit.html`
- **変更内容**: 有効/無効のチェックボックスを追加

### 4. マイグレーションスクリプト
- **ファイル**: `migrate_add_employee_active.py`（新規作成）
- **内容**: 既存のデータベースに`active`カラムを追加

## 使用方法

### 従業員一覧ページでの切り替え

1. システム管理者またはテナント管理者でログイン
2. 従業員一覧ページ（`/tenant_admin/employees`）にアクセス
3. 切り替えたい従業員の「有効」列にあるボタンをクリック
4. 状態が即座に切り替わり、フラッシュメッセージが表示される

### 従業員編集ページでの切り替え

1. システム管理者またはテナント管理者でログイン
2. 従業員一覧ページで「編集」ボタンをクリック
3. 「有効」チェックボックスをオン/オフに切り替え
4. 「更新」ボタンをクリックして保存

## デプロイ手順

### Herokuでのマイグレーション実行

本番環境（Heroku）でこの機能を有効にするには、以下のコマンドを実行してください：

```bash
heroku run python migrate_add_employee_active.py -a login-system-app-ecd1c20680c1
```

または、Herokuのダッシュボードから「Run Console」を開いて以下を実行：

```bash
python migrate_add_employee_active.py
```

### デプロイの確認

GitHubにプッシュ済みですので、Herokuが自動的にデプロイを行います。Herokuのダッシュボードでデプロイ状況を確認してください。

## セキュリティとアクセス制御

### 権限チェック

すべてのエンドポイントで適切な権限チェックを実装しています：

- `@require_roles(ROLES["TENANT_ADMIN"], ROLES["SYSTEM_ADMIN"])`デコレータを使用
- システム管理者とテナント管理者のみがアクセス可能
- テナント分離：各管理者は自分のテナントの従業員のみを管理可能

### テナント分離

すべてのSQLクエリで`tenant_id`を条件に含めることで、テナント間のデータ分離を保証しています。

## UI/UX改善

### レスポンシブデザイン

既存のレスポンシブデザインを維持し、スマートフォンでも快適に操作できます：

- デスクトップ：テーブル形式で表示
- スマートフォン：カード形式で表示

### 視覚的なフィードバック

- **有効な従業員**: 緑色のボタン（`#4caf50`）
- **無効な従業員**: グレーのボタン（`#999`）
- **フラッシュメッセージ**: 操作結果を明確に通知

## 今後の改善提案

### 1. ログイン時の有効性チェック

現在、`active`カラムは追加されましたが、ログイン処理で有効性をチェックする必要があります。無効な従業員がログインできないように、認証処理を更新することを推奨します。

### 2. 一括操作

複数の従業員を一度に有効/無効にする機能を追加すると、管理が効率化されます。

### 3. 監査ログ

従業員の有効/無効の切り替え履歴をログに記録することで、セキュリティと監査性が向上します。

### 4. 通知機能

従業員が無効化された際に、メールやシステム通知で本人に通知する機能を追加できます。

## まとめ

従業員の有効/無効切り替え機能の実装が完了しました。以下の機能が正常に動作しています：

- ✅ T_従業員テーブルに`active`カラムを追加
- ✅ 従業員一覧ページに有効/無効のトグルボタンを追加
- ✅ 従業員編集ページに有効/無効のチェックボックスを追加
- ✅ ワンクリックで状態を切り替え可能
- ✅ フラッシュメッセージで操作結果を通知
- ✅ 権限チェックとテナント分離を実装
- ✅ レスポンシブデザインに対応

この機能により、システム管理者とテナント管理者は、従業員のアクティブ状態を簡単に管理できるようになりました。

## GitHubリポジトリ

変更はGitHubにプッシュ済みです：
- **リポジトリ**: https://github.com/system-asayama/login-system-app
- **コミット**: 従業員の有効/無効切り替え機能を実装

## アクセス方法

### 本番環境（Heroku）

マイグレーション実行後、以下のURLでアクセスできます：

**従業員一覧ページ**: https://login-system-app-ecd1c20680c1.herokuapp.com/tenant_admin/employees

システム管理者またはテナント管理者でログインしてアクセスしてください。
