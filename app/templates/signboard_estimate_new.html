{% extends "base.html" %}

{% block title %}è¦‹ç©ã‚‚ã‚Šæ–°è¦ä½œæˆ{% endblock %}
{% block header %}è¦‹ç©ã‚‚ã‚Šæ–°è¦ä½œæˆ{% endblock %}

{% block content %}
<div class="card">
  <form method="POST" id="estimateForm">
    <div class="grid">
      <div>
        <label for="customer_name">é¡§å®¢å</label>
        <input type="text" id="customer_name" name="customer_name" placeholder="æ ªå¼ä¼šç¤¾ã€‡ã€‡" />
      </div>

      <!-- è¨­è¨ˆå›³ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div style="margin-top: 1.5rem; padding: 1rem; border: 2px dashed #ccc; border-radius: 8px; background: #f9f9f9;">
        <h3 style="margin-top: 0; margin-bottom: 0.5rem;">è¨­è¨ˆå›³ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆAIè‡ªå‹•è§£æï¼‰</h3>
        <p style="font-size: 0.9rem; color: #666; margin-bottom: 0.8rem;">è¨­è¨ˆå›³ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ã€AIãŒå¯¸æ³•ã‚„æè³ªã‚’è‡ªå‹•çš„ã«è§£æã—ã¦å…¥åŠ›ã—ã¾ã™ã€‚</p>
        
        <input type="file" id="blueprintCamera" accept="image/*" capture="environment" style="display: none;" onchange="handleBlueprintUpload(event)" />
        <input type="file" id="blueprintGallery" accept="image/*" style="display: none;" onchange="handleBlueprintUpload(event)" />
        
        <div style="display: flex; gap: 0.5rem;">
          <button type="button" onclick="document.getElementById('blueprintCamera').click()" class="btn" style="background: #007bff; color: white;">
            ğŸ“· ã‚«ãƒ¡ãƒ©ã§æ’®å½±
          </button>
          <button type="button" onclick="document.getElementById('blueprintGallery').click()" class="btn" style="background: #28a745; color: white;">
            ğŸ–¼ï¸ ã‚®ãƒ£ãƒ©ãƒªãƒ¼ã‹ã‚‰é¸æŠ
          </button>
        </div>
        
        <div id="uploadStatus" style="margin-top: 0.8rem; display: none;">
          <div id="uploadProgress" style="display: none;">
            <div style="background: #e9ecef; border-radius: 4px; overflow: hidden; height: 24px;">
              <div id="progressBar" style="background: #007bff; height: 100%; width: 0%; transition: width 0.3s;"></div>
            </div>
            <p style="font-size: 0.9rem; color: #666; margin-top: 0.3rem;">è§£æä¸­...</p>
          </div>
          <div id="uploadResult" style="display: none;"></div>
        </div>
        
        <div id="blueprintPreview" style="margin-top: 0.8rem; display: none;">
          <img id="previewImage" src="" alt="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼" style="max-width: 100%; max-height: 300px; border-radius: 4px; border: 1px solid #ddd;" />
        </div>
      </div>

      <div>
        <h3 style="margin-top: 1.5rem; margin-bottom: 0.5rem;">æ˜ç´°</h3>
        <div id="itemsContainer">
          <!-- æ˜ç´°è¡ŒãŒã“ã“ã«è¿½åŠ ã•ã‚Œã‚‹ -->
        </div>
        <button type="button" onclick="addItem()" class="btn" style="margin-top: 0.5rem;">+ æ˜ç´°ã‚’è¿½åŠ </button>
      </div>

      <div id="totalPreview" style="display: none; background: #f5f5f5; padding: 1rem; border-radius: 8px; margin-top: 1rem;">
        <h3 style="margin-top: 0;">åˆè¨ˆé‡‘é¡</h3>
        <table style="width: 100%;">
          <tr style="border-top: 1px solid #ddd;">
            <td style="padding-top: 0.5rem;"><strong>å°è¨ˆ:</strong></td>
            <td style="text-align: right; padding-top: 0.5rem;"><strong>Â¥<span id="totalSubtotal">0</span></strong></td>
          </tr>
          <tr>
            <td>æ¶ˆè²»ç¨ï¼ˆ10%ï¼‰:</td>
            <td style="text-align: right;">Â¥<span id="totalTax">0</span></td>
          </tr>
          <tr style="border-top: 2px solid #333;">
            <td style="padding-top: 0.5rem;"><strong>åˆè¨ˆé‡‘é¡:</strong></td>
            <td style="text-align: right; padding-top: 0.5rem; font-size: 1.2rem;"><strong>Â¥<span id="totalAmount">0</span></strong></td>
          </tr>
        </table>
      </div>

      <div>
        <label for="notes">å‚™è€ƒ</label>
        <textarea id="notes" name="notes" rows="3" style="width: 100%; padding: 0.6rem; border: 1px solid #ccc; border-radius: 8px; font-family: inherit;"></textarea>
      </div>

      <div style="display: flex; gap: 0.5rem;">
        <button type="submit" class="btn btn-primary">è¦‹ç©ã‚‚ã‚Šã‚’ä½œæˆ</button>
        <a href="{{ url_for('signboard.index') }}" class="btn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</a>
      </div>
    </div>
  </form>
</div>

<script>
let itemCounter = 0;
let materials = {{ materials|tojson }};

function addItem() {
  itemCounter++;
  const container = document.getElementById('itemsContainer');
  
  const itemDiv = document.createElement('div');
  itemDiv.id = `item-${itemCounter}`;
  itemDiv.className = 'item-row';
  itemDiv.style.cssText = 'border: 1px solid #ddd; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; position: relative;';
  
  let materialOptions = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
  materials.forEach(mat => {
    const priceType = mat[2] === 'area' ? '(é¢ç©å˜ä¾¡)' : '(é‡é‡å˜ä¾¡)';
    materialOptions += `<option value="${mat[0]}" data-price-type="${mat[2]}">${mat[1]} ${priceType}</option>`;
  });
  
  itemDiv.innerHTML = `
    <button type="button" onclick="removeItem(${itemCounter})" style="position: absolute; top: 0.5rem; right: 0.5rem; background: #dc3545; color: white; border: none; border-radius: 4px; padding: 0.3rem 0.6rem; cursor: pointer;">å‰Šé™¤</button>
    
    <div style="margin-bottom: 0.5rem;">
      <label>æè³ª <span style="color: red;">*</span></label>
      <select name="items[${itemCounter}][material_id]" required onchange="calculateItemPrice(${itemCounter})">
        ${materialOptions}
      </select>
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 0.5rem;">
      <div>
        <label>å¹…ï¼ˆmmï¼‰ <span style="color: red;">*</span></label>
        <input type="number" name="items[${itemCounter}][width]" step="0.1" min="0" required onchange="calculateItemPrice(${itemCounter})" placeholder="1000" />
      </div>
      <div>
        <label>é«˜ã•ï¼ˆmmï¼‰ <span style="color: red;">*</span></label>
        <input type="number" name="items[${itemCounter}][height]" step="0.1" min="0" required onchange="calculateItemPrice(${itemCounter})" placeholder="600" />
      </div>
    </div>
    
    <div style="margin-bottom: 0.5rem;">
      <label>æ•°é‡ <span style="color: red;">*</span></label>
      <input type="number" name="items[${itemCounter}][quantity]" min="1" value="1" required onchange="calculateItemPrice(${itemCounter})" />
    </div>
    
    <div id="itemPreview-${itemCounter}" style="display: none; background: #e9ecef; padding: 0.5rem; border-radius: 4px; font-size: 0.9rem;">
      <div style="display: flex; justify-content: space-between;">
        <span>é¢ç©: <span id="itemArea-${itemCounter}">-</span> ã¡</span>
        <span id="itemWeight-${itemCounter}" style="display: none;">é‡é‡: <span id="itemWeightValue-${itemCounter}">-</span> kg</span>
      </div>
      <div style="display: flex; justify-content: space-between; margin-top: 0.3rem;">
        <span>å˜ä¾¡: Â¥<span id="itemUnitPrice-${itemCounter}">-</span></span>
        <strong>å°è¨ˆ: Â¥<span id="itemSubtotal-${itemCounter}">-</span></strong>
      </div>
    </div>
  `;
  
  container.appendChild(itemDiv);
  updateTotalPreview();
}

function removeItem(itemId) {
  const itemDiv = document.getElementById(`item-${itemId}`);
  if (itemDiv) {
    itemDiv.remove();
    updateTotalPreview();
  }
}

let calculateTimeouts = {};

function calculateItemPrice(itemId) {
  clearTimeout(calculateTimeouts[itemId]);
  
  const itemDiv = document.getElementById(`item-${itemId}`);
  const materialSelect = itemDiv.querySelector(`select[name="items[${itemId}][material_id]"]`);
  const widthInput = itemDiv.querySelector(`input[name="items[${itemId}][width]"]`);
  const heightInput = itemDiv.querySelector(`input[name="items[${itemId}][height]"]`);
  const quantityInput = itemDiv.querySelector(`input[name="items[${itemId}][quantity]"]`);
  
  const materialId = materialSelect.value;
  const width = widthInput.value;
  const height = heightInput.value;
  const quantity = quantityInput.value;
  
  if (!materialId || !width || !height || !quantity) {
    document.getElementById(`itemPreview-${itemId}`).style.display = 'none';
    updateTotalPreview();
    return;
  }
  
  calculateTimeouts[itemId] = setTimeout(() => {
    fetch('{{ url_for("signboard.api_calculate") }}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        material_id: materialId,
        width: parseFloat(width),
        height: parseFloat(height),
        quantity: parseInt(quantity)
      })
    })
    .then(response => response.json())
    .then(result => {
      if (result.success) {
        const data = result.data;
        
        document.getElementById(`itemArea-${itemId}`).textContent = data.area.toFixed(4);
        document.getElementById(`itemUnitPrice-${itemId}`).textContent = data.unit_price.toLocaleString();
        document.getElementById(`itemSubtotal-${itemId}`).textContent = data.subtotal.toLocaleString();
        
        // é‡é‡è¡¨ç¤º
        if (data.weight !== null) {
          document.getElementById(`itemWeightValue-${itemId}`).textContent = data.weight.toFixed(2);
          document.getElementById(`itemWeight-${itemId}`).style.display = 'inline';
        } else {
          document.getElementById(`itemWeight-${itemId}`).style.display = 'none';
        }
        
        document.getElementById(`itemPreview-${itemId}`).style.display = 'block';
        updateTotalPreview();
      } else {
        alert('è¨ˆç®—ã‚¨ãƒ©ãƒ¼: ' + result.error);
      }
    })
    .catch(error => {
      console.error('Error:', error);
    });
  }, 500);
}

function updateTotalPreview() {
  let totalSubtotal = 0;
  let hasItems = false;
  
  document.querySelectorAll('.item-row').forEach(itemDiv => {
    const subtotalSpan = itemDiv.querySelector('[id^="itemSubtotal-"]');
    if (subtotalSpan && subtotalSpan.textContent !== '-') {
      const subtotal = parseFloat(subtotalSpan.textContent.replace(/,/g, ''));
      if (!isNaN(subtotal)) {
        totalSubtotal += subtotal;
        hasItems = true;
      }
    }
  });
  
  if (hasItems) {
    const totalTax = Math.floor(totalSubtotal * 0.1);
    const totalAmount = totalSubtotal + totalTax;
    
    document.getElementById('totalSubtotal').textContent = totalSubtotal.toLocaleString();
    document.getElementById('totalTax').textContent = totalTax.toLocaleString();
    document.getElementById('totalAmount').textContent = totalAmount.toLocaleString();
    document.getElementById('totalPreview').style.display = 'block';
  } else {
    document.getElementById('totalPreview').style.display = 'none';
  }
}

// è¨­è¨ˆå›³ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†
function handleBlueprintUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
  const reader = new FileReader();
  reader.onload = function(e) {
    document.getElementById('previewImage').src = e.target.result;
    document.getElementById('blueprintPreview').style.display = 'block';
  };
  reader.readAsDataURL(file);
  
  // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¨AIè§£æ
  const formData = new FormData();
  formData.append('image', file);
  
  // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹è¡¨ç¤º
  document.getElementById('uploadStatus').style.display = 'block';
  document.getElementById('uploadProgress').style.display = 'block';
  document.getElementById('uploadResult').style.display = 'none';
  document.getElementById('progressBar').style.width = '30%';
  
  fetch('/auto_estimate/analyze', {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(result => {
    document.getElementById('progressBar').style.width = '100%';
    document.getElementById('uploadProgress').style.display = 'none';
    
    if (result.success) {
      // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      document.getElementById('uploadResult').innerHTML = `
        <div style="padding: 0.8rem; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 4px; color: #155724;">
          <strong>âœ… AIè§£æå®Œäº†ï¼</strong><br>
          <span style="font-size: 0.9rem;">è§£æçµæœã‚’æ˜ç´°ã«è‡ªå‹•å…¥åŠ›ã—ã¾ã—ãŸã€‚</span>
        </div>
      `;
      document.getElementById('uploadResult').style.display = 'block';
      
      // è§£æçµæœã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«å…¥åŠ›
      applyAnalysisResult(result.data);
    } else {
      document.getElementById('uploadResult').innerHTML = `
        <div style="padding: 0.8rem; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; color: #721c24;">
          <strong>âŒ ã‚¨ãƒ©ãƒ¼</strong><br>
          <span style="font-size: 0.9rem;">${result.error || 'è§£æã«å¤±æ•—ã—ã¾ã—ãŸ'}</span>
        </div>
      `;
      document.getElementById('uploadResult').style.display = 'block';
    }
  })
  .catch(error => {
    console.error('Error:', error);
    document.getElementById('progressBar').style.width = '100%';
    document.getElementById('uploadProgress').style.display = 'none';
    document.getElementById('uploadResult').innerHTML = `
      <div style="padding: 0.8rem; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; color: #721c24;">
        <strong>âŒ ã‚¨ãƒ©ãƒ¼</strong><br>
        <span style="font-size: 0.9rem;">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</span>
      </div>
    `;
    document.getElementById('uploadResult').style.display = 'block';
  });
}

function applyAnalysisResult(data) {
  // é¡§å®¢åã‚’å…¥åŠ›
  if (data.customer_name) {
    document.getElementById('customer_name').value = data.customer_name;
  }
  
  // è§£æçµæœãŒãªã„å ´åˆã¯çµ‚äº†
  if (!data.items || data.items.length === 0) {
    return;
  }
  
  // æ—¢å­˜ã®æ˜ç´°ã‚’ã™ã¹ã¦å‰Šé™¤
  const existingItems = document.querySelectorAll('.item-row');
  existingItems.forEach(item => item.remove());
  
  // å„è§£æçµæœã«å¯¾ã—ã¦æ˜ç´°ã‚’è¿½åŠ 
  data.items.forEach((item, index) => {
    // æ˜ç´°ã‚’è¿½åŠ 
    addItem();
    
    // è¿½åŠ ã•ã‚ŒãŸæ˜ç´°ã‚’å–å¾—
    const itemDivs = document.querySelectorAll('.item-row');
    const itemDiv = itemDivs[itemDivs.length - 1];
    
    if (itemDiv) {
      // æè³ªã‚’é¸æŠ
      if (item.material_name) {
        const materialSelect = itemDiv.querySelector('select[name^="items"][name$="[material_id]"]');
        if (materialSelect) {
          // æè³ªåã‹ã‚‰æè³ªIDã‚’æ¤œç´¢ï¼ˆéƒ¨åˆ†ä¸€è‡´ã‚‚è¨±å¯ï¼‰
          const material = materials.find(m => {
            const materialName = m[1].toLowerCase();
            const searchName = item.material_name.toLowerCase();
            return materialName.includes(searchName) || searchName.includes(materialName);
          });
          if (material) {
            materialSelect.value = material[0];
          }
        }
      }
      
      // å¹…ã‚’å…¥åŠ›
      if (item.width) {
        const widthInput = itemDiv.querySelector('input[name^="items"][name$="[width]"]');
        if (widthInput) {
          widthInput.value = item.width;
        }
      }
      
      // é«˜ã•ã‚’å…¥åŠ›
      if (item.height) {
        const heightInput = itemDiv.querySelector('input[name^="items"][name$="[height]"]');
        if (heightInput) {
          heightInput.value = item.height;
        }
      }
      
      // æ•°é‡ã‚’å…¥åŠ›
      if (item.quantity) {
        const quantityInput = itemDiv.querySelector('input[name^="items"][name$="[quantity]"]');
        if (quantityInput) {
          quantityInput.value = item.quantity;
        }
      }
      
      // å‚™è€ƒã‚’å…¥åŠ›ï¼ˆæœ€åˆã®æ˜ç´°ã®ã¿ï¼‰
      if (index === 0 && item.description) {
        document.getElementById('notes').value = item.description;
      }
      
      // ä¾¡æ ¼è¨ˆç®—ã‚’ãƒˆãƒªã‚¬ãƒ¼
      const itemId = itemDiv.id.replace('item-', '');
      setTimeout(() => {
        calculateItemPrice(itemId);
      }, 100 * (index + 1)); // é…å»¶ã‚’å°‘ã—ãšã¤ãšã‚‰ã™
    }
  });
}

// åˆæœŸæ˜ç´°ã‚’1ã¤è¿½åŠ 
document.addEventListener('DOMContentLoaded', function() {
  addItem();
});
</script>
{% endblock %}
