{% extends "base.html" %}

{% block title %}è¦‹ç©ã‚‚ã‚Šæ–°è¦ä½œæˆ{% endblock %}
{% block header %}è¦‹ç©ã‚‚ã‚Šæ–°è¦ä½œæˆ{% endblock %}

{% block content %}
<div style="margin-bottom: 1.5rem; padding: 1rem; background: #f0f8ff; border-left: 4px solid #007bff; border-radius: 4px;">
  <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.3rem;">
    <strong style="color: #007bff;">è¦‹ç©ã‚¿ã‚¤ãƒ—:</strong>
    <span>{{ subtype_info[2] if subtype_info else 'æœªé¸æŠ' }}</span>
    <span style="color: #999;">></span>
    <span>{{ subtype_info[0] if subtype_info else 'æœªé¸æŠ' }}</span>
  </div>
  {% if subtype_info and subtype_info[1] %}
  <p style="margin: 0; font-size: 0.9rem; color: #666;">{{ subtype_info[1] }}</p>
  {% endif %}
  <a href="{{ url_for('estimate_type.select_type') }}" style="font-size: 0.85rem; color: #007bff; text-decoration: none;">â† è¦‹ç©ã‚¿ã‚¤ãƒ—ã‚’å¤‰æ›´</a>
</div>

<div class="card">
  <form method="POST" id="estimateForm">
    <!-- AIè§£æã§ç”Ÿæˆã•ã‚ŒãŸè‡ªå‹•è¦‹ç©ã‚‚ã‚ŠIDï¼ˆéè¡¨ç¤ºï¼‰ -->
    <input type="hidden" id="auto_estimate_id" name="auto_estimate_id" value="" />
    
    <div class="grid">
      <div>
        <label for="customer_name">é¡§å®¢å</label>
        <input type="text" id="customer_name" name="customer_name" placeholder="æ ªå¼ä¼šç¤¾ã€‡ã€‡" />
      </div>

      <!-- è¨­è¨ˆå›³ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div style="margin-top: 1.5rem; padding: 1rem; border: 2px dashed #ccc; border-radius: 8px; background: #f9f9f9;">
        <h3 style="margin-top: 0; margin-bottom: 0.5rem;">è¨­è¨ˆå›³ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆAIè‡ªå‹•è§£æï¼‰</h3>
        <p style="font-size: 0.9rem; color: #666; margin-bottom: 0.8rem;">è¨­è¨ˆå›³ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ã€AIãŒå¯¸æ³•ã‚„æè³ªã‚’è‡ªå‹•çš„ã«è§£æã—ã¦å…¥åŠ›ã—ã¾ã™ã€‚</p>
        
        <input type="file" id="blueprintCamera" accept="image/*" capture="environment" style="display: none;" onchange="handleBlueprintUpload(event, 'camera')" />
        <input type="file" id="blueprintGallery" accept="image/*,application/pdf" multiple style="display: none;" onchange="handleBlueprintUpload(event, 'gallery')" />
        
        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
          <button type="button" onclick="document.getElementById('blueprintCamera').click()" class="btn" style="background: #007bff; color: white;">
            ğŸ“· ã‚«ãƒ¡ãƒ©ã§æ’®å½±
          </button>
          <button type="button" onclick="document.getElementById('blueprintGallery').click()" class="btn" style="background: #28a745; color: white;">
            ğŸ–¼ï¸ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠï¼ˆè¤‡æ•°å¯ã€PDFå¯¾å¿œï¼‰
          </button>
        </div>
        
        <div style="margin-top: 0.8rem;">
          <label style="display: flex; align-items: center; gap: 0.3rem; font-size: 0.9rem;">
            <input type="radio" name="uploadMode" value="replace" checked>
            <span>ç½®ãæ›ãˆï¼ˆæ—¢å­˜ã®æ˜ç´°ã‚’ã‚¯ãƒªã‚¢ï¼‰</span>
          </label>
          <label style="display: flex; align-items: center; gap: 0.3rem; font-size: 0.9rem; margin-top: 0.3rem;">
            <input type="radio" name="uploadMode" value="append">
            <span>è¿½åŠ ï¼ˆæ—¢å­˜ã®æ˜ç´°ã«è¿½åŠ ï¼‰</span>
          </label>
        </div>
        
        <div id="uploadStatus" style="margin-top: 0.8rem; display: none;">
          <div id="uploadProgress" style="display: none;">
            <div style="background: #e9ecef; border-radius: 4px; overflow: hidden; height: 24px;">
              <div id="progressBar" style="background: #007bff; height: 100%; width: 0%; transition: width 0.3s;"></div>
            </div>
            <p style="font-size: 0.9rem; color: #666; margin-top: 0.3rem;">è§£æä¸­...</p>
          </div>
          <div id="uploadResult" style="display: none;"></div>
        </div>
        
        <div id="blueprintPreview" style="margin-top: 0.8rem; display: none;">
          <img id="previewImage" src="" alt="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼" style="max-width: 100%; max-height: 300px; border-radius: 4px; border: 1px solid #ddd;" />
        </div>
      </div>

      <div>
        <h3 style="margin-top: 1.5rem; margin-bottom: 0.5rem;">æ˜ç´°</h3>
        <div id="itemsContainer">
          <!-- æ˜ç´°è¡ŒãŒã“ã“ã«è¿½åŠ ã•ã‚Œã‚‹ -->
        </div>
        <button type="button" onclick="addItem()" class="btn" style="margin-top: 0.5rem;">+ æ˜ç´°ã‚’è¿½åŠ </button>
      </div>

      <div id="totalPreview" style="display: none; background: #f5f5f5; padding: 1rem; border-radius: 8px; margin-top: 1rem;">
        <h3 style="margin-top: 0;">åˆè¨ˆé‡‘é¡</h3>
        <table style="width: 100%;">
          <tr style="border-top: 1px solid #ddd;">
            <td style="padding-top: 0.5rem;"><strong>å°è¨ˆ:</strong></td>
            <td style="text-align: right; padding-top: 0.5rem;"><strong>Â¥<span id="totalSubtotal">0</span></strong></td>
          </tr>
          <tr>
            <td>æ¶ˆè²»ç¨ï¼ˆ10%ï¼‰:</td>
            <td style="text-align: right;">Â¥<span id="totalTax">0</span></td>
          </tr>
          <tr style="border-top: 2px solid #333;">
            <td style="padding-top: 0.5rem;"><strong>åˆè¨ˆé‡‘é¡:</strong></td>
            <td style="text-align: right; padding-top: 0.5rem; font-size: 1.2rem;"><strong>Â¥<span id="totalAmount">0</span></strong></td>
          </tr>
        </table>
      </div>

      <div>
        <label for="notes">å‚™è€ƒ</label>
        <textarea id="notes" name="notes" rows="3" style="width: 100%; padding: 0.6rem; border: 1px solid #ccc; border-radius: 8px; font-family: inherit;"></textarea>
      </div>

      <div style="display: flex; gap: 0.5rem;">
        <button type="submit" class="btn btn-primary">è¦‹ç©ã‚‚ã‚Šã‚’ä½œæˆ</button>
        <a href="{{ url_for('signboard.index') }}" class="btn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</a>
      </div>
    </div>
  </form>
</div>

<script>
let itemCounter = 0;
let materials = {{ materials|tojson }};

function addItem() {
  itemCounter++;
  const container = document.getElementById('itemsContainer');
  
  const itemDiv = document.createElement('div');
  itemDiv.id = `item-${itemCounter}`;
  itemDiv.className = 'item-row';
  itemDiv.style.cssText = 'border: 1px solid #ddd; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; position: relative;';
  
  let materialOptions = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
  materials.forEach(mat => {
    const priceType = mat[2] === 'area' ? '(é¢ç©å˜ä¾¡)' : mat[2] === 'volume' ? '(ä½“ç©å˜ä¾¡)' : '(é‡é‡å˜ä¾¡)';
    const shapeType = mat[3] || 'square';
    const wallThickness = mat[4] || '';
    const supportsTextProcessing = mat[5] || false;
    materialOptions += `<option value="${mat[0]}" data-price-type="${mat[2]}" data-shape-type="${shapeType}" data-wall-thickness="${wallThickness}" data-supports-text-processing="${supportsTextProcessing}">${mat[1]} ${priceType}</option>`;
  });
  
  itemDiv.innerHTML = `
    <button type="button" onclick="removeItem(${itemCounter})" style="position: absolute; top: 0.5rem; right: 0.5rem; background: #dc3545; color: white; border: none; border-radius: 4px; padding: 0.3rem 0.6rem; cursor: pointer;">å‰Šé™¤</button>
    
    <div style="margin-bottom: 0.5rem;">
      <label>æè³ª <span style="color: red;">*</span></label>
      <select name="items[${itemCounter}][material_id]" required onchange="onMaterialChange(${itemCounter})">
        ${materialOptions}
      </select>
    </div>
    
    <div style="margin-bottom: 0.5rem;">
      <label>å½¢çŠ¶ã‚¿ã‚¤ãƒ— <span style="color: red;">*</span></label>
      <select id="shapeType-${itemCounter}" name="items[${itemCounter}][shape_type]" required onchange="calculateItemPrice(${itemCounter})">
        <option value="square">è§’å½¢</option>
        <option value="round_solid">ä¸¸å½¢ï¼ˆä¸­å®Ÿï¼‰</option>
        <option value="round_pipe">ä¸¸å½¢ï¼ˆãƒ‘ã‚¤ãƒ—ï¼‰</option>
      </select>
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 0.5rem;">
      <div>
        <label>å¹…ï¼ˆmmï¼‰ <span style="color: red;">*</span></label>
        <input type="number" name="items[${itemCounter}][width]" step="0.1" min="0" required onchange="calculateItemPrice(${itemCounter})" placeholder="1000" />
      </div>
      <div>
        <label>é«˜ã•ï¼ˆmmï¼‰ <span style="color: red;">*</span></label>
        <input type="number" name="items[${itemCounter}][height]" step="0.1" min="0" required onchange="calculateItemPrice(${itemCounter})" placeholder="600" />
      </div>
    </div>
    
    <div style="margin-bottom: 0.5rem;">
      <label>æ•°é‡ <span style="color: red;">*</span></label>
      <input type="number" name="items[${itemCounter}][quantity]" min="1" value="1" required onchange="calculateItemPrice(${itemCounter})" />
    </div>
    
    <div id="itemPreview-${itemCounter}" style="display: none; background: #e9ecef; padding: 0.5rem; border-radius: 4px; font-size: 0.9rem;">
      <div style="display: flex; justify-content: space-between;">
        <span>é¢ç©: <span id="itemArea-${itemCounter}">-</span> ã¡</span>
        <span id="itemWeight-${itemCounter}" style="display: none;">é‡é‡: <span id="itemWeightValue-${itemCounter}">-</span> kg</span>
      </div>
      <div style="display: flex; justify-content: space-between; margin-top: 0.3rem;">
        <span>å˜ä¾¡: Â¥<span id="itemUnitPrice-${itemCounter}">-</span></span>
        <strong>å°è¨ˆ: Â¥<span id="itemSubtotal-${itemCounter}">-</span></strong>
      </div>
    </div>
    
    <!-- æ–‡å­—åŠ å·¥UI -->
    <div id="textProcessing-${itemCounter}" style="display: none; background: #fff3cd; padding: 1rem; border-radius: 8px; margin-top: 1rem; border: 2px solid #ffc107;">
      <h4 style="margin: 0 0 0.8rem 0; color: #856404;">âœ‚ï¸ æ–‡å­—åŠ å·¥æƒ…å ±</h4>
      
      <div style="margin-bottom: 0.8rem;">
        <label>å…¥åŠ›æ–¹æ³•</label>
        <select id="textMode-${itemCounter}" name="items[${itemCounter}][text_processing_mode]" onchange="onTextModeChange(${itemCounter})" style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;">
          <option value="overall">å…¨ä½“ã‚µã‚¤ã‚ºï¼ˆç°¡æ˜“è¦‹ç©ã‚‚ã‚Šï¼‰</option>
          <option value="individual">1æ–‡å­—ãšã¤ï¼ˆç²¾å¯†è¦‹ç©ã‚‚ã‚Šï¼‰</option>
        </select>
      </div>
      
      <!-- å…¨ä½“ã‚µã‚¤ã‚ºãƒ¢ãƒ¼ãƒ‰ -->
      <div id="overallMode-${itemCounter}">
        <div style="margin-bottom: 0.5rem;">
          <label>æ–‡å­—å†…å®¹</label>
          <input type="text" name="items[${itemCounter}][text_content]" placeholder="ä¾‹: å–¶æ¥­ä¸­" onchange="calculatePerimeter(${itemCounter})" style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;" />
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 0.5rem;">
          <div>
            <label>å…¨ä½“å¹…ï¼ˆmmï¼‰</label>
            <input type="number" name="items[${itemCounter}][text_width]" step="0.1" min="0" placeholder="300" onchange="calculatePerimeter(${itemCounter})" style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;" />
          </div>
          <div>
            <label>å…¨ä½“é«˜ã•ï¼ˆmmï¼‰</label>
            <input type="number" name="items[${itemCounter}][text_height]" step="0.1" min="0" placeholder="100" onchange="calculatePerimeter(${itemCounter})" style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;" />
          </div>
        </div>
        
        <div style="margin-bottom: 0.5rem;">
          <label>æ–‡å­—ç¨®é¡</label>
          <select id="characterType-${itemCounter}" name="items[${itemCounter}][character_type_id]" onchange="calculatePerimeter(${itemCounter})" style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
          </select>
        </div>
      </div>
      
      <!-- 1æ–‡å­—ãšã¤ãƒ¢ãƒ¼ãƒ‰ -->
      <div id="individualMode-${itemCounter}" style="display: none;">
        <div id="characterList-${itemCounter}" style="margin-bottom: 0.5rem;">
          <!-- æ–‡å­—è¡ŒãŒå‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
        </div>
        <button type="button" onclick="addCharacter(${itemCounter})" style="background: #28a745; color: white; border: none; border-radius: 4px; padding: 0.5rem 1rem; cursor: pointer;">+ æ–‡å­—è¿½åŠ </button>
      </div>
      
      <!-- æ¨å®šå‘¨é•·ã¨åŠ å·¥è³ƒ -->
      <div style="background: white; padding: 0.8rem; border-radius: 4px; margin-top: 0.8rem; border: 1px solid #ffc107;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 0.5rem;">
          <div>
            <label style="font-size: 0.85rem; color: #666;">æ¨å®šå‘¨é•·</label>
            <div style="font-size: 1.1rem; font-weight: bold; color: #856404;"><span id="estimatedPerimeter-${itemCounter}">-</span> mm</div>
          </div>
          <div>
            <label style="font-size: 0.85rem; color: #666;">å®Ÿæ¸¬å‘¨é•·ï¼ˆä»»æ„ï¼‰</label>
            <input type="number" name="items[${itemCounter}][actual_perimeter]" step="0.1" min="0" placeholder="å®Ÿæ¸¬å€¤" onchange="calculatePerimeter(${itemCounter})" style="width: 100%; padding: 0.4rem; border: 1px solid #ccc; border-radius: 4px; font-size: 0.9rem;" />
          </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
          <div>
            <label style="font-size: 0.85rem; color: #666;">å‘¨é•·å˜ä¾¡ï¼ˆå††/mmï¼‰</label>
            <input type="number" name="items[${itemCounter}][perimeter_unit_price]" step="0.1" min="0" value="5" onchange="calculatePerimeter(${itemCounter})" style="width: 100%; padding: 0.4rem; border: 1px solid #ccc; border-radius: 4px; font-size: 0.9rem;" />
          </div>
          <div>
            <label style="font-size: 0.85rem; color: #666;">åŠ å·¥è³ƒ</label>
            <div style="font-size: 1.2rem; font-weight: bold; color: #28a745;">Â¥<span id="processingCost-${itemCounter}">-</span></div>
          </div>
        </div>
      </div>
    </div>
  `;
  
  container.appendChild(itemDiv);
  updateTotalPreview();
}

function removeItem(itemId) {
  const itemDiv = document.getElementById(`item-${itemId}`);
  if (itemDiv) {
    itemDiv.remove();
    updateTotalPreview();
  }
}

function onMaterialChange(itemId) {
  const itemDiv = document.getElementById(`item-${itemId}`);
  const materialSelect = itemDiv.querySelector(`select[name="items[${itemId}][material_id]"]`);
  const shapeTypeSelect = document.getElementById(`shapeType-${itemId}`);
  const textProcessingDiv = document.getElementById(`textProcessing-${itemId}`);
  
  const selectedOption = materialSelect.options[materialSelect.selectedIndex];
  const shapeType = selectedOption.getAttribute('data-shape-type') || 'square';
  const supportsTextProcessing = selectedOption.getAttribute('data-supports-text-processing') === 'true';
  
  // æè³ªã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå½¢çŠ¶ã‚¿ã‚¤ãƒ—ã‚’è¨­å®š
  shapeTypeSelect.value = shapeType;
  
  // æ–‡å­—åŠ å·¥UIã®è¡¨ç¤º/éè¡¨ç¤º
  if (supportsTextProcessing) {
    textProcessingDiv.style.display = 'block';
    // æ–‡å­—å‘¨é•·ä¿‚æ•°ã‚’èª­ã¿è¾¼ã‚€
    loadPerimeterCoefficients(itemId);
  } else {
    textProcessingDiv.style.display = 'none';
  }
  
  calculateItemPrice(itemId);
}

let calculateTimeouts = {};

function calculateItemPrice(itemId) {
  clearTimeout(calculateTimeouts[itemId]);
  
  const itemDiv = document.getElementById(`item-${itemId}`);
  const materialSelect = itemDiv.querySelector(`select[name="items[${itemId}][material_id]"]`);
  const widthInput = itemDiv.querySelector(`input[name="items[${itemId}][width]"]`);
  const heightInput = itemDiv.querySelector(`input[name="items[${itemId}][height]"]`);
  const quantityInput = itemDiv.querySelector(`input[name="items[${itemId}][quantity]"]`);
  
  const materialId = materialSelect.value;
  const width = widthInput.value;
  const height = heightInput.value;
  const quantity = quantityInput.value;
  
  if (!materialId || !width || !height || !quantity) {
    document.getElementById(`itemPreview-${itemId}`).style.display = 'none';
    updateTotalPreview();
    return;
  }
  
  calculateTimeouts[itemId] = setTimeout(() => {
    fetch('{{ url_for("signboard.api_calculate") }}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        material_id: materialId,
        width: parseFloat(width),
        height: parseFloat(height),
        quantity: parseInt(quantity)
      })
    })
    .then(response => response.json())
    .then(result => {
      if (result.success) {
        const data = result.data;
        
        document.getElementById(`itemArea-${itemId}`).textContent = data.area.toFixed(4);
        document.getElementById(`itemUnitPrice-${itemId}`).textContent = data.unit_price.toLocaleString();
        document.getElementById(`itemSubtotal-${itemId}`).textContent = data.subtotal.toLocaleString();
        
        // é‡é‡è¡¨ç¤º
        if (data.weight !== null) {
          document.getElementById(`itemWeightValue-${itemId}`).textContent = data.weight.toFixed(2);
          document.getElementById(`itemWeight-${itemId}`).style.display = 'inline';
        } else {
          document.getElementById(`itemWeight-${itemId}`).style.display = 'none';
        }
        
        document.getElementById(`itemPreview-${itemId}`).style.display = 'block';
        updateTotalPreview();
      } else {
        alert('è¨ˆç®—ã‚¨ãƒ©ãƒ¼: ' + result.error);
      }
    })
    .catch(error => {
      console.error('Error:', error);
    });
  }, 500);
}

function updateTotalPreview() {
  let totalSubtotal = 0;
  let hasItems = false;
  
  document.querySelectorAll('.item-row').forEach(itemDiv => {
    const subtotalSpan = itemDiv.querySelector('[id^="itemSubtotal-"]');
    if (subtotalSpan && subtotalSpan.textContent !== '-') {
      const subtotal = parseFloat(subtotalSpan.textContent.replace(/,/g, ''));
      if (!isNaN(subtotal)) {
        totalSubtotal += subtotal;
        hasItems = true;
      }
    }
  });
  
  if (hasItems) {
    const totalTax = Math.floor(totalSubtotal * 0.1);
    const totalAmount = totalSubtotal + totalTax;
    
    document.getElementById('totalSubtotal').textContent = totalSubtotal.toLocaleString();
    document.getElementById('totalTax').textContent = totalTax.toLocaleString();
    document.getElementById('totalAmount').textContent = totalAmount.toLocaleString();
    document.getElementById('totalPreview').style.display = 'block';
  } else {
    document.getElementById('totalPreview').style.display = 'none';
  }
}

// è¨­è¨ˆå›³ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†
function handleBlueprintUpload(event, source) {
  const files = event.target.files;
  if (!files || files.length === 0) return;
  
  // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºï¼ˆæœ€åˆã®ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ï¼‰
  if (files[0].type.startsWith('image/')) {
    const reader = new FileReader();
    reader.onload = function(e) {
      document.getElementById('previewImage').src = e.target.result;
      document.getElementById('blueprintPreview').style.display = 'block';
    };
    reader.readAsDataURL(files[0]);
  } else {
    document.getElementById('blueprintPreview').style.display = 'none';
  }
  
  // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¨AIè§£æ
  const formData = new FormData();
  
  // è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã™ã¹ã¦è¿½åŠ 
  for (let i = 0; i < files.length; i++) {
    formData.append('files', files[i]);
  }
  
  // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ‰ã‚’å–å¾—
  const uploadMode = document.querySelector('input[name="uploadMode"]:checked').value;
  formData.append('mode', uploadMode);
  
  // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹è¡¨ç¤º
  document.getElementById('uploadStatus').style.display = 'block';
  document.getElementById('uploadProgress').style.display = 'block';
  document.getElementById('uploadResult').style.display = 'none';
  document.getElementById('progressBar').style.width = '30%';
  
  fetch('/auto_estimate/analyze', {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(result => {
    document.getElementById('progressBar').style.width = '100%';
    document.getElementById('uploadProgress').style.display = 'none';
    
    if (result.success) {
      // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      document.getElementById('uploadResult').innerHTML = `
        <div style="padding: 0.8rem; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 4px; color: #155724;">
          <strong>âœ… AIè§£æå®Œäº†ï¼</strong><br>
          <span style="font-size: 0.9rem;">è§£æçµæœã‚’æ˜ç´°ã«è‡ªå‹•å…¥åŠ›ã—ã¾ã—ãŸã€‚</span>
        </div>
      `;
      document.getElementById('uploadResult').style.display = 'block';
      
      // è‡ªå‹•è¦‹ç©ã‚‚ã‚ŠIDã‚’hiddenãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«è¨­å®š
      if (result.data && result.data.auto_estimate_id) {
        document.getElementById('auto_estimate_id').value = result.data.auto_estimate_id;
      }
      
      // è§£æçµæœã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«å…¥åŠ›
      const uploadMode = document.querySelector('input[name="uploadMode"]:checked').value;
      applyAnalysisResult(result.data, uploadMode);
    } else {
      document.getElementById('uploadResult').innerHTML = `
        <div style="padding: 0.8rem; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; color: #721c24;">
          <strong>âŒ ã‚¨ãƒ©ãƒ¼</strong><br>
          <span style="font-size: 0.9rem;">${result.error || 'è§£æã«å¤±æ•—ã—ã¾ã—ãŸ'}</span>
        </div>
      `;
      document.getElementById('uploadResult').style.display = 'block';
    }
  })
  .catch(error => {
    console.error('Error:', error);
    document.getElementById('progressBar').style.width = '100%';
    document.getElementById('uploadProgress').style.display = 'none';
    document.getElementById('uploadResult').innerHTML = `
      <div style="padding: 0.8rem; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; color: #721c24;">
        <strong>âŒ ã‚¨ãƒ©ãƒ¼</strong><br>
        <span style="font-size: 0.9rem;">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</span>
      </div>
    `;
    document.getElementById('uploadResult').style.display = 'block';
  });
}

function applyAnalysisResult(data, mode) {
  // é¡§å®¢åã‚’å…¥åŠ›ï¼ˆç½®ãæ›ãˆãƒ¢ãƒ¼ãƒ‰ã®ã¿ï¼‰
  if (mode === 'replace' && data.customer_name) {
    document.getElementById('customer_name').value = data.customer_name;
  }
  
  // è§£æçµæœãŒãªã„å ´åˆã¯çµ‚äº†
  if (!data.items || data.items.length === 0) {
    return;
  }
  
  // ç½®ãæ›ãˆãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã®ã¿æ—¢å­˜ã®æ˜ç´°ã‚’å‰Šé™¤
  if (mode === 'replace') {
    const existingItems = document.querySelectorAll('.item-row');
    existingItems.forEach(item => item.remove());
  }
  
  // å„è§£æçµæœã«å¯¾ã—ã¦æ˜ç´°ã‚’è¿½åŠ 
  data.items.forEach((item, index) => {
    // æ˜ç´°ã‚’è¿½åŠ 
    addItem();
    
    // è¿½åŠ ã•ã‚ŒãŸæ˜ç´°ã‚’å–å¾—
    const itemDivs = document.querySelectorAll('.item-row');
    const itemDiv = itemDivs[itemDivs.length - 1];
    
    if (itemDiv) {
      // æè³ªã‚’é¸æŠ
      if (item.material_name) {
        const materialSelect = itemDiv.querySelector('select[name^="items"][name$="[material_id]"]');
        if (materialSelect) {
          // æè³ªåã‹ã‚‰æè³ªIDã‚’æ¤œç´¢ï¼ˆéƒ¨åˆ†ä¸€è‡´ã‚‚è¨±å¯ï¼‰
          const material = materials.find(m => {
            const materialName = m[1].toLowerCase();
            const searchName = item.material_name.toLowerCase();
            return materialName.includes(searchName) || searchName.includes(materialName);
          });
          if (material) {
            materialSelect.value = material[0];
          }
        }
      }
      
      // å¹…ã‚’å…¥åŠ›
      if (item.width) {
        const widthInput = itemDiv.querySelector('input[name^="items"][name$="[width]"]');
        if (widthInput) {
          widthInput.value = item.width;
        }
      }
      
      // é«˜ã•ã‚’å…¥åŠ›
      if (item.height) {
        const heightInput = itemDiv.querySelector('input[name^="items"][name$="[height]"]');
        if (heightInput) {
          heightInput.value = item.height;
        }
      }
      
      // æ•°é‡ã‚’å…¥åŠ›
      if (item.quantity) {
        const quantityInput = itemDiv.querySelector('input[name^="items"][name$="[quantity]"]');
        if (quantityInput) {
          quantityInput.value = item.quantity;
        }
      }
      
      // å‚™è€ƒã‚’å…¥åŠ›ï¼ˆæœ€åˆã®æ˜ç´°ã®ã¿ï¼‰
      if (index === 0 && item.description) {
        document.getElementById('notes').value = item.description;
      }
      
      // ä¾¡æ ¼è¨ˆç®—ã‚’ãƒˆãƒªã‚¬ãƒ¼
      const itemId = itemDiv.id.replace('item-', '');
      setTimeout(() => {
        calculateItemPrice(itemId);
      }, 100 * (index + 1)); // é…å»¶ã‚’å°‘ã—ãšã¤ãšã‚‰ã™
    }
  });
}

// æ–‡å­—å‘¨é•·ä¿‚æ•°ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥
let perimeterCoefficients = [];

// æ–‡å­—å‘¨é•·ä¿‚æ•°ã‚’èª­ã¿è¾¼ã‚€
function loadPerimeterCoefficients(itemId) {
  // æ—¢ã«èª­ã¿è¾¼ã¿æ¸ˆã¿ã®å ´åˆã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ç”¨
  if (perimeterCoefficients.length > 0) {
    populateCharacterTypes(itemId);
    return;
  }
  
  fetch('{{ url_for("perimeter_coefficient.api_list") }}')
    .then(response => response.json())
    .then(result => {
      if (result.success) {
        perimeterCoefficients = result.data;
        populateCharacterTypes(itemId);
      } else {
        console.error('æ–‡å­—å‘¨é•·ä¿‚æ•°ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', result.error);
      }
    })
    .catch(error => {
      console.error('Error:', error);
    });
}

// æ–‡å­—ç¨®é¡ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’è¨­å®š
function populateCharacterTypes(itemId) {
  const characterTypeSelect = document.getElementById(`characterType-${itemId}`);
  if (!characterTypeSelect) return;
  
  // æ—¢å­˜ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢ï¼ˆæœ€åˆã®ã€Œé¸æŠã—ã¦ãã ã•ã„ã€ä»¥å¤–ï¼‰
  while (characterTypeSelect.options.length > 1) {
    characterTypeSelect.remove(1);
  }
  
  // ä¿‚æ•°ã‚’è¿½åŠ 
  perimeterCoefficients.forEach(coeff => {
    const option = document.createElement('option');
    option.value = coeff.id;
    option.textContent = `${coeff.character_type} (ä¿‚æ•°: ${coeff.coefficient})`;
    option.setAttribute('data-coefficient', coeff.coefficient);
    characterTypeSelect.appendChild(option);
  });
}

// å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
function onTextModeChange(itemId) {
  const textMode = document.getElementById(`textMode-${itemId}`).value;
  const overallMode = document.getElementById(`overallMode-${itemId}`);
  const individualMode = document.getElementById(`individualMode-${itemId}`);
  
  if (textMode === 'overall') {
    overallMode.style.display = 'block';
    individualMode.style.display = 'none';
  } else {
    overallMode.style.display = 'none';
    individualMode.style.display = 'block';
  }
  
  calculatePerimeter(itemId);
}

let perimeterCalculateTimeouts = {};

// æ¨å®šå‘¨é•·ã¨åŠ å·¥è³ƒã‚’è¨ˆç®—
function calculatePerimeter(itemId) {
  clearTimeout(perimeterCalculateTimeouts[itemId]);
  
  perimeterCalculateTimeouts[itemId] = setTimeout(() => {
    const textMode = document.getElementById(`textMode-${itemId}`).value;
    
    if (textMode === 'overall') {
      calculatePerimeterOverall(itemId);
    } else {
      calculatePerimeterIndividual(itemId);
    }
  }, 500);
}

// å…¨ä½“ã‚µã‚¤ã‚ºãƒ¢ãƒ¼ãƒ‰ã®å‘¨é•·è¨ˆç®—
function calculatePerimeterOverall(itemId) {
  const itemDiv = document.getElementById(`item-${itemId}`);
  const textContent = itemDiv.querySelector(`input[name="items[${itemId}][text_content]"]`).value;
  const textHeight = itemDiv.querySelector(`input[name="items[${itemId}][text_height]"]`).value;
  const characterTypeSelect = document.getElementById(`characterType-${itemId}`);
  const actualPerimeter = itemDiv.querySelector(`input[name="items[${itemId}][actual_perimeter]"]`).value;
  const perimeterUnitPrice = itemDiv.querySelector(`input[name="items[${itemId}][perimeter_unit_price]"]`).value;
  
  if (!textContent || !textHeight || !characterTypeSelect.value) {
    document.getElementById(`estimatedPerimeter-${itemId}`).textContent = '-';
    document.getElementById(`processingCost-${itemId}`).textContent = '-';
    return;
  }
  
  const characterCount = textContent.length;
  const selectedOption = characterTypeSelect.options[characterTypeSelect.selectedIndex];
  const coefficient = parseFloat(selectedOption.getAttribute('data-coefficient'));
  
  // æ¨å®šå‘¨é•· = æ–‡å­—é«˜ã• Ã— æ–‡å­—æ•° Ã— ä¿‚æ•°
  const estimatedPerimeter = parseFloat(textHeight) * characterCount * coefficient;
  
  // å®Ÿæ¸¬å‘¨é•·ãŒã‚ã‚Œã°ãã‚Œã‚’å„ªå…ˆ
  const finalPerimeter = actualPerimeter ? parseFloat(actualPerimeter) : estimatedPerimeter;
  
  // åŠ å·¥è³ƒ = å‘¨é•· Ã— å‘¨é•·å˜ä¾¡
  const processingCost = Math.floor(finalPerimeter * parseFloat(perimeterUnitPrice || 0));
  
  document.getElementById(`estimatedPerimeter-${itemId}`).textContent = Math.floor(estimatedPerimeter).toLocaleString();
  document.getElementById(`processingCost-${itemId}`).textContent = processingCost.toLocaleString();
}

// 1æ–‡å­—ãšã¤ãƒ¢ãƒ¼ãƒ‰ã®å‘¨é•·è¨ˆç®—
function calculatePerimeterIndividual(itemId) {
  // TODO: 1æ–‡å­—ãšã¤ãƒ¢ãƒ¼ãƒ‰ã®å®Ÿè£…ï¼ˆå¾Œã§è¿½åŠ ï¼‰
  document.getElementById(`estimatedPerimeter-${itemId}`).textContent = '-';
  document.getElementById(`processingCost-${itemId}`).textContent = '-';
}

// 1æ–‡å­—è¿½åŠ ï¼ˆå°†æ¥ã®å®Ÿè£…ç”¨ï¼‰
function addCharacter(itemId) {
  // TODO: 1æ–‡å­—ãšã¤ãƒ¢ãƒ¼ãƒ‰ã®å®Ÿè£…ï¼ˆå¾Œã§è¿½åŠ ï¼‰
  alert('ã“ã®æ©Ÿèƒ½ã¯ç¾åœ¨é–‹ç™ºä¸­ã§ã™ã€‚ã¾ãšã¯å…¨ä½“ã‚µã‚¤ã‚ºãƒ¢ãƒ¼ãƒ‰ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚');
}

// åˆæœŸæ˜ç´°ã‚’1ã¤è¿½åŠ 
document.addEventListener('DOMContentLoaded', function() {
  addItem();
});
</script>
{% endblock %}
