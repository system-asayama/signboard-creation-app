{% extends "base.html" %}

{% block title %}材質編集{% endblock %}
{% block header %}材質編集{% endblock %}

{% block content %}
<div class="card">
  <form method="POST">
    <div class="grid">
      <div>
        <label for="category_id">大分類 <span style="color: red;">*</span></label>
        <select id="category_id" name="category_id" required onchange="loadSubcategories()">
          <option value="">選択してください</option>
          {% for category in categories %}
          <option value="{{ category[0] }}" {% if material[11] == category[0] %}selected{% endif %}>{{ category[1] }} - {{ category[2] }}</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label for="subcategory_id">中分類</label>
        <select id="subcategory_id" name="subcategory_id">
          <option value="">選択してください</option>
          {% for subcategory in subcategories %}
          <option value="{{ subcategory[0] }}" {% if material[12] == subcategory[0] %}selected{% endif %}>{{ subcategory[1] }}</option>
          {% endfor %}
        </select>
        <small style="color: #666;">※大分類を選択すると中分類が絞り込まれます</small>
      </div>

      <div>
        <label for="name">材質名 <span style="color: red;">*</span></label>
        <input type="text" id="name" name="name" value="{{ material[1] }}" required />
      </div>

      <div>
        <label for="price_type">単価タイプ <span style="color: red;">*</span></label>
        <select id="price_type" name="price_type" required onchange="togglePriceFields()">
          <option value="area" {% if material[2] == 'area' %}selected{% endif %}>面積単価（円/㎡）</option>
          <option value="volume" {% if material[2] == 'volume' %}selected{% endif %}>体積単価（円/㎥）</option>
        </select>
      </div>

      <div id="area_price_field" style="display: {% if material[2] == 'area' %}block{% else %}none{% endif %};">
        <label for="unit_price_area">面積単価（円/㎡）</label>
        <input type="number" id="unit_price_area" name="unit_price_area" step="0.01" min="0" value="{{ material[3] if material[3] else '' }}" />
      </div>

      <div id="volume_price_field" style="display: {% if material[2] == 'volume' %}block{% else %}none{% endif %};">
        <label for="unit_price_volume">体積単価（円/㎥）</label>
        <input type="number" id="unit_price_volume" name="unit_price_volume" step="0.01" min="0" value="{{ material[5] if material[5] else '' }}" />
      </div>

      <div id="shape_type_field" style="display: {% if material[11] and categories|selectattr('0', 'equalto', material[11])|map(attribute='1')|first in ['支柱', '構造部材'] %}block{% else %}none{% endif %};">
        <label for="shape_type">形状タイプ <span style="color: red;">*</span></label>
        <select id="shape_type" name="shape_type" onchange="toggleWallThicknessField()">
          <option value="square" {% if material[9] == 'square' or not material[9] %}selected{% endif %}>角形</option>
          <option value="round_solid" {% if material[9] == 'round_solid' %}selected{% endif %}>丸形（中実）</option>
          <option value="round_pipe" {% if material[9] == 'round_pipe' %}selected{% endif %}>丸形（パイプ）</option>
        </select>
      </div>

      <div id="wall_thickness_field" style="display: {% if material[9] == 'round_pipe' %}block{% else %}none{% endif %};">
        <label for="wall_thickness">肉厚（mm）</label>
        <input type="number" id="wall_thickness" name="wall_thickness" step="0.01" min="0" value="{{ material[10] if material[10] else '' }}" placeholder="3.0" />
        <small style="color: #666;">※丸形パイプの場合のみ使用されます</small>
      </div>

      <div>
        <label for="description">説明</label>
        <textarea id="description" name="description" rows="3" style="width: 100%; padding: 0.6rem; border: 1px solid #ccc; border-radius: 8px; font-family: inherit;">{{ material[8] if material[8] else '' }}</textarea>
      </div>

      <div>
        <label>
          <input type="checkbox" id="supports_text_processing" name="supports_text_processing" {% if material[13] %}checked{% endif %} />
          文字加工対応（カッティングシート等）
        </label>
        <small style="color: #666; display: block; margin-top: 0.25rem;">※チェックすると見積もり作成時に文字周長計算機能が使えます</small>
      </div>

      <div style="display: flex; gap: 0.5rem;">
        <button type="submit" class="btn btn-primary">更新</button>
        <a href="{{ url_for('signboard.materials') }}" class="btn">キャンセル</a>
      </div>
    </div>
  </form>
</div>

<script>
function togglePriceFields() {
  const priceType = document.getElementById('price_type').value;
  const areaField = document.getElementById('area_price_field');
  const volumeField = document.getElementById('volume_price_field');
  const areaInput = document.getElementById('unit_price_area');
  const volumeInput = document.getElementById('unit_price_volume');
  
  if (priceType === 'area') {
    areaField.style.display = 'block';
    volumeField.style.display = 'none';
    areaInput.required = true;
    volumeInput.required = false;
  } else if (priceType === 'volume') {
    areaField.style.display = 'none';
    volumeField.style.display = 'block';
    areaInput.required = false;
    volumeInput.required = true;
  }
}

function toggleWallThicknessField() {
  const shapeType = document.getElementById('shape_type').value;
  const wallThicknessField = document.getElementById('wall_thickness_field');
  
  wallThicknessField.style.display = shapeType === 'round_pipe' ? 'block' : 'none';
}

// 中分類を読み込む
function loadSubcategories() {
  const categoryId = document.getElementById('category_id').value;
  const subcategorySelect = document.getElementById('subcategory_id');
  const currentSubcategoryId = {{ material[12] if material[12] else 'null' }};
  const shapeTypeField = document.getElementById('shape_type_field');
  const shapeTypeSelect = document.getElementById('shape_type');
  
  // リセット
  subcategorySelect.innerHTML = '<option value="">選択してください</option>';
  
  if (!categoryId) {
    shapeTypeField.style.display = 'none';
    shapeTypeSelect.removeAttribute('required');
    return;
  }
  
  // 選択された大分類のテキストを取得
  const categorySelect = document.getElementById('category_id');
  const selectedOption = categorySelect.options[categorySelect.selectedIndex];
  const categoryText = selectedOption.text;
  
  // 「支柱・構造部材」が含まれる場合のみ形状タイプを表示
  if (categoryText.includes('支柱') || categoryText.includes('構造部材')) {
    shapeTypeField.style.display = 'block';
    shapeTypeSelect.setAttribute('required', 'required');
  } else {
    shapeTypeField.style.display = 'none';
    shapeTypeSelect.removeAttribute('required');
  }
  
  // APIで中分類を取得
  fetch(`/signboard/categories/api/subcategories/${categoryId}`)
    .then(response => response.json())
    .then(data => {
      data.forEach(sub => {
        const option = document.createElement('option');
        option.value = sub.id;
        option.textContent = sub.name;
        if (currentSubcategoryId && sub.id === currentSubcategoryId) {
          option.selected = true;
        }
        subcategorySelect.appendChild(option);
      });
    })
    .catch(error => {
      console.error('Error loading subcategories:', error);
    });
}
</script>
{% endblock %}
