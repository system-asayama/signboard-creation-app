# ログインシステムアプリ プロジェクト分析レポート

## 現在の実装状況

### システム概要
Flask製の多階層ロール認証システムで、以下の4つのロールを持つ階層的な権限管理システムです。

### ロール構成
1. **システム管理者 (system_admin)**: 全テナント横断の最高権限
2. **テナント管理者 (tenant_admin)**: テナント単位の管理者
3. **管理者 (admin)**: 店舗/拠点などの管理者
4. **従業員 (employee)**: 一般従業員

### データベーススキーマ
- **T_管理者**: システム管理者、テナント管理者、店舗管理者を格納
  - `is_owner`: オーナーフラグ（1=オーナー、0=一般管理者）
  - `can_manage_admins`: 管理者管理権限フラグ
- **T_従業員**: 従業員を格納
- **T_テナント**: テナント情報を格納
- **T_店舗**: 店舗情報を格納

### 実装済み機能

#### 1. 認証・セキュリティ
- パスワードハッシュ化（werkzeug.security）
- CSRF保護
- セッション管理
- ロールベースアクセス制御

#### 2. システム管理者機能
- テナントの作成・編集・削除
- システム管理者の管理
- テナント管理者の管理

#### 3. テナント管理者機能
- テナント情報の表示・編集
- テナント管理者の管理（オーナー権限が必要）
- 店舗の作成・編集・削除
- 店舗管理者の管理

#### 4. 店舗管理者機能
- 従業員の管理
- **オーナー権限機能**（最近実装）
  - 最初の管理者にオーナー権限を付与
  - オーナーのみが管理者の新規作成・削除が可能
  - オーナー権限を他の管理者に移譲可能

#### 5. データベース対応
- PostgreSQL / SQLite 自動切り替え
- スキーマ自動作成（冪等性保証）

### 技術スタック
- **フレームワーク**: Flask 3.0.0
- **データベース**: PostgreSQL / SQLite
- **ORM**: SQLAlchemy 2.0.36
- **WSGIサーバー**: gunicorn 23.0.0
- **環境変数管理**: python-dotenv 1.0.1

### ディレクトリ構造
```
login-system-app/
├── app/
│   ├── __init__.py          # アプリケーションファクトリ
│   ├── config.py            # 設定ファイル
│   ├── logging.py           # ロギング設定
│   ├── utils/               # ユーティリティモジュール
│   │   ├── db.py            # DB接続・スキーマ初期化
│   │   ├── security.py      # セキュリティ関連
│   │   └── decorators.py    # デコレータ（require_roles等）
│   ├── blueprints/          # Blueprint（機能別ルート）
│   │   ├── health.py        # ヘルスチェック
│   │   ├── auth.py          # 認証関連
│   │   ├── system_admin.py  # システム管理者
│   │   ├── tenant_admin.py  # テナント管理者
│   │   ├── admin.py         # 管理者
│   │   └── employee.py      # 従業員
│   └── templates/           # Jinjaテンプレート（85ファイル）
├── requirements.txt         # 依存パッケージ
├── .env.example             # 環境変数サンプル
├── wsgi.py                  # WSGIエントリーポイント
└── Procfile                 # Heroku設定
```

## 既知の問題点と改善提案

### 1. 店舗と管理者/従業員の紐づけ不足
**現状**: 店舗管理者と従業員は`tenant_id`のみで管理されており、特定の店舗に紐づいていません。

**推奨される改善**:
- `T_管理者`テーブルに`store_id`カラムを追加
- `T_従業員`テーブルに`store_id`カラムを追加
- 店舗詳細ページから、その店舗に紐づく管理者と従業員のみを表示・管理できるようにする

### 2. 権限管理の強化
- 店舗管理者が自分の店舗の従業員のみを管理できるように制限
- テナント管理者が自分のテナントの店舗のみを管理できるように制限

### 3. UI/UXの改善
- 店舗詳細ページから店舗に紐づく管理者と従業員の数を正確に表示
- パンくずリストの追加でナビゲーションを改善
- 確認ダイアログの統一（削除時など）

### 4. セキュリティの強化
- CSRFトークンの実装（現在は一部のみ）
- パスワードポリシーの実装（最小文字数、複雑さ要件）
- ログイン試行回数の制限
- 監査ログの実装

### 5. 機能拡張の提案
- 複数オーナーのサポート
- 権限レベルの細分化（読み取り専用管理者など）
- 通知機能（オーナー権限移譲時など）
- 一時的な権限委譲機能

### 6. デプロイメント
- 本番環境へのデプロイ準備
- PostgreSQLへの移行（現在はSQLiteを使用）
- 環境変数の適切な設定
- ログ管理の強化

## 次のステップの提案

以下の優先順位で開発を進めることを提案します：

### 優先度：高
1. **店舗と管理者/従業員の紐づけ実装**
   - データベーススキーマの拡張（`store_id`カラム追加）
   - マイグレーションスクリプトの作成
   - 店舗管理者作成時に店舗を選択できるようにする
   - 従業員作成時に店舗を選択できるようにする
   - 店舗詳細ページで紐づく管理者・従業員を表示

2. **権限管理の強化**
   - 店舗管理者が自分の店舗の従業員のみを管理できるように制限
   - アクセス制御の強化

### 優先度：中
3. **UI/UXの改善**
   - パンくずリストの追加
   - 確認ダイアログの統一
   - エラーメッセージの改善

4. **セキュリティの強化**
   - CSRFトークンの完全実装
   - パスワードポリシーの実装
   - ログイン試行回数の制限

### 優先度：低
5. **機能拡張**
   - 監査ログの実装
   - 通知機能の実装
   - 複数オーナーのサポート

## まとめ

現在のログインシステムアプリは、基本的な多階層ロール認証システムとして機能していますが、店舗と管理者/従業員の紐づけが不足しているため、実用的なシステムとして運用するには改善が必要です。

次のステップとして、最も重要な「店舗と管理者/従業員の紐づけ実装」から着手することを推奨します。
